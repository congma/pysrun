# pysrun

pysrun 是用Python编写的北师大上网认证网关客户端.


## 使用说明

### 安装

本脚本无需安装其它程序库, 只需要下载即可执行. 需要用到的文件有两个:

1. `pysrun`: 可执行Python脚本,
2. 配置文件, 默认路径为`~/.pysrun.cfg`.

软件包提供了样例配置文件`pysrun.cfg.default`. 第一次使用前, 建议将其拷贝到
`~/.pysrun.cfg`, 同时填入包括用户名密码在内的相关信息.  您可以将可执行文件
`pysrun`放在任何路径下, 建议放在`PATH`环境变量所包含的目录下.


### 配置文件

配置文件分为如下部分, 每个部分中有若干个选项.

1. `[Server]`
填写北师大认证服务器信息. 除非有很特殊的情况, 请不要修改这组选项.
 * `address`: 服务器IP地址或主机名.  默认值: 172.16.202.201.
 * `port`: 服务器监听端口. 客户端通过向这个端口上监听的服务器发送信息来工作.
 默认值: 3333.
2. `[Client]`
用于配置客户端所运行需要的主机信息.
 * `interface`: 在哪个网络界面上认证. 此界面的MAC地址将成为认证信息的一部分.
 默认值: eth0 (小窍门: 请查看 `ifconfig` 之类命令的输出决定界面的名称).
3. `[Account]`
填写用户帐号信息.
 * `username`: 帐号 (通常为学工号), 无默认值.
 * `password`: 密码, 无默认值.
4. `[Session]`
用于配置会话状态的保存.
 * `uidfile`: 保存所谓"uid"信息的文件路径. 每次登入, 服务器会返回一个uid.
 登出时需要使用这个uid退出. `uidfile`路径所指示的文件用来存放每次登入所返回的uid. 在登出前, 不要修改这个文件的内容或者移动乃至删除这个文件.
 默认值: `~/.pysrun_uid`.

配置文件的格式要求如下:

1. 文件由行组成. 满足合格要求的行, 必须是`key = value`的形式. 主键 (key),
等号和键值 (value) 都可以被任意多的空白字符 (如空格和制表符) 所包围,
空白字符可以出现在主键或键值中, 但不能是开头或结尾的字符.  如果有多个等号,
第一个等号为主键和键值的分隔符, 其余为键值的一部分.
2. 满足合格要求的主键-键值对, 其主键或键值都不能为空.
3. 注释文字以井号 (`#`) 开始.
4. 任何不满足以上要求的行, 都被忽略. 可以认为它们都是注释.
5. 如果一个主键在文件中重复出现, 最后一次出现的合格键值起作用.

在配置文件中, 上述被中括号括起来的部分 (如`[Server]`) 起到每一节标题的作用.
在0.4版本以前, 它们必须如此.  自从0.4版本开始, 它们可以被彻底删去,
不发挥任何作用, 相当于文件格式第4条所描述的注释.
我们建议您不再使用中括号定义的标题, 最好是替换成用`#`符号开始的注释,
以增加配置文件的可读性.


### 命令行选项

上述配置文件中的选项, 都有命令行的对应体.  因此, 本程序在没有配置文件
(或者配置文件不包含任何可辨认的内容) 的情况下也可以使用.  命令行选项如下所述:

* `-u USERNAME`: 用于指出用户名, 对应于配置文件的`username`选项.
* `-p PASSWORD`: 用于指出密码, 对应于配置文件的`password`选项.
* `-a ADDRESS`: 认证服务器地址或主机名, 对应于配置文件的`address`选项
* `-P PORT`: 认证服务器通信端口, 对应于配置文件的`port`选项.
* `-i INTERFACE`: 用于获取MAC地址的网络界面, 对应于`interface`选项.
* `-s FILE`: "uid"信息存储文件的路径, 对应于`uidfile`选项.

*请注意!*  以上命令行选项都优先于配置文件发挥作用.  也就是说,
一旦命令行给出了某选项, 那么无论在配置文件中如何设置, 都以命令行选项为准.

更多命令行选项如下:

* `-c FILE`: 指定配置文件路径, 用于提供不同于默认路径 (`~/.pysrun.cfg`)
的配置文件.  小窍门: 用 `-c /dev/null` 可以彻底告别配置文件.
* `-I`: 交互式输入密码.  输入的内容将不会回显.  如果使用这一选项,
则交互式输入的内容优先于其它方式给出的密码.
* `-d`: 打开调试信息显示.
* `-h`: 显示使用帮助信息并退出, 不进行任何操作.


### 登入, 登出和强制离线操作

1. 登入: 使用`pysrun login`命令. 登入成功后将安静地退出.  需要提供`username`和`password`选项.
2. 登出: 使用`pysrun logout`命令.  需要知道uid, 因此须提供`uidfile`选项.
3. 强制离线: 又称踢人, 即让所有占用这个帐号的IP地址离线, 使用`pysrun kick`命令.
需要提供`username`和`password`选项.

*注意:* 需要让`pysrun`所在目录在您的`PATH`环境变量中, 否则应使用类似 `./pysrun`
的绝对路径启动程序.


### 用法示例

1. `pysrun -c /dev/null -i wlan0 -u USERNAME -p PASSWORD login`  
使用wlan0界面的MAC地址, 不读取任何配置文件 (即只用默认值), 登入.
2. `echo 'pysrun kick' | at midnight`  
通过[`at`][at-man]提交一个定时任务, 在今天半夜时刻踢掉所有在线用户.


## 适用系统

目前在Linux系统上经过基本测试, 可以满足最简单的功能需要. 在各种BSD系统上
(包括Free/Net/Open/DragonFlyBSD) 也可以使用, 但未经过测试.

本程序不依赖于系统是32或64位.


## 背景

北师大提供的"官方"Linux客户端是一个动态编译的32位程序. 它具有如下不足:

* 不适用于64位系统, 需要在64位系统上再安装32位C标准库.
* 是"黑箱"程序, 无源码, 不知其工作原理, 必须诉诸逆向工程.
* 自Linux 2.6.35后, 出现了官方客户端无法使用的情况. 其原因是官方客户端在进行
`bind()`调用时采取了不规范的用法, 被较新的内核认为是错误的调用而无法执行
(参见https://lkml.org/lkml/2011/7/9/37, 或 [Linux commit d0733d2e][d0733d2e]).
这导致在较新的系统上官方客户端完全失效.

> 附注: 在更新的系统上, `bind()`到`AF_UNSPEC`类型的地址被允许用于地址为`INADDR_ANY`,
见 [Linux commit 29c486df][29c486df], 而这也正是官方客户端所做的.
所以对于此commit以后的内核版本, 上一点不能用于作为否定官方客户端的较强论据.

同时, 北师大也没有给出对各种BSD系统的支持. 尽管很多BSD系统建有Linux兼容层,
但通过兼容层运行本来就编写甚为sloppy的Linux程序可能遇到各种问题.

因此, 我们需要一个新的客户端可以改变以上所列的不足. 新客户端支持Linux和各种BSD,
支持32位和64位系统, 有开放的源码, 而且避免了原客户端中的不规范编程.


## 授权

BSD许可证, 见文件COPYRIGHT.


[d0733d2e]: https://github.com/torvalds/linux/commit/d0733d2e29b652b2e7b1438ececa732e4eed98eb "Linux commit d0733d2e29b652b2e7b1438ececa732e4eed98eb"
[29c486df]: https://github.com/torvalds/linux/commit/29c486df6a208432b370bd4be99ae1369ede28d8 "Linux commit 29c486df6a208432b370bd4be99ae1369ede28d8"
[at-man]: http://linux.die.net/man/1/at "Linux manual page for at(1)"


## 版本信息

2012-04-25 version 0.5.1.
